name: Build Neuronpedia Webapp

on:
  workflow_dispatch:
    inputs:
      neuronpedia_ref:
        description: 'Neuronpedia repo ref (branch/tag/commit)'
        required: false
        default: 'main'

env:
  REGISTRY: docker.io
  IMAGE_NAME: hitsai/neuronpedia-webapp

jobs:
  build:
    # Only run in hitsainet/miStudio (same as docker-images.yml)
    if: github.repository == 'hitsainet/miStudio'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout miStudio repo
        uses: actions/checkout@v4
        with:
          path: mistudio

      - name: Checkout Neuronpedia repo
        uses: actions/checkout@v4
        with:
          repository: hijohnnylin/neuronpedia
          ref: ${{ github.event.inputs.neuronpedia_ref || 'main' }}
          path: neuronpedia

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Update .env.localhost to disable demo mode
        working-directory: neuronpedia/apps/webapp
        run: |
          # Update the existing .env.localhost file to disable demo mode
          # This is cleaner than creating a new file

          # First, check current content
          echo "=== Original .env.localhost ==="
          cat .env.localhost

          # Append our overrides (these take precedence)
          cat >> .env.localhost << 'ENVEOF'

          # === MiStudio Custom Overrides ===
          # CRITICAL: Disable demo mode at build time
          NEXT_PUBLIC_DEMO_MODE=false

          # Contact email
          NEXT_PUBLIC_CONTACT_EMAIL_ADDRESS=admin@mcslab.io

          # Local inference (not public demo servers)
          INFERENCE_SERVER_SECRET=local-secret
          AUTOINTERPRET_SERVER_SECRET=local-secret
          ENVEOF

          echo ""
          echo "=== Updated .env.localhost ==="
          cat .env.localhost

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: neuronpedia/apps/webapp
          file: neuronpedia/apps/webapp/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Use the default .env.localhost (which we've modified)
          build-args: |
            ENV_FILE=.env.localhost

      - name: Output image info
        run: |
          echo "✅ Image pushed: ${{ env.IMAGE_NAME }}:latest"
          echo "✅ Image pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "To deploy to K8s, run:"
          echo "  kubectl -n neuronpedia set image deployment/neuronpedia-webapp webapp=${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "Or with specific SHA:"
          echo "  kubectl -n neuronpedia set image deployment/neuronpedia-webapp webapp=${{ env.IMAGE_NAME }}:${{ github.sha }}"
