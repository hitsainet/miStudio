name: Build Neuronpedia Webapp

on:
  workflow_dispatch:
    inputs:
      neuronpedia_ref:
        description: 'Neuronpedia repo ref (branch/tag/commit)'
        required: false
        default: 'main'

env:
  REGISTRY: docker.io
  IMAGE_NAME: hitsai/neuronpedia-webapp

jobs:
  build:
    # Only run in hitsainet/miStudio (same as docker-images.yml)
    if: github.repository == 'hitsainet/miStudio'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout miStudio repo
        uses: actions/checkout@v4
        with:
          path: mistudio

      - name: Checkout Neuronpedia repo
        uses: actions/checkout@v4
        with:
          repository: hijohnnylin/neuronpedia
          ref: ${{ github.event.inputs.neuronpedia_ref || 'main' }}
          path: neuronpedia

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create custom .env for localhost build
        run: |
          cat > neuronpedia/apps/webapp/.env << 'EOF'
          # Custom build for self-hosted Neuronpedia (non-demo mode)

          # Domain settings (will be overridden at runtime)
          NEXT_PUBLIC_URL=http://localhost:3000
          NEXTAUTH_URL=http://localhost:3000
          NEXTAUTH_SECRET=placeholder-will-be-overridden-at-runtime

          # Database (will be overridden at runtime)
          POSTGRES_PRISMA_URL=postgres://postgres:postgres@localhost:5432/postgres
          POSTGRES_URL_NON_POOLING=postgres://postgres:postgres@localhost:5432/postgres

          # CRITICAL: Disable demo mode at build time
          NEXT_PUBLIC_DEMO_MODE=false

          # Contact email
          NEXT_PUBLIC_CONTACT_EMAIL_ADDRESS=admin@mcslab.io

          # Default Model settings
          NEXT_PUBLIC_DEFAULT_MODELID=gemma-2-2b
          NEXT_PUBLIC_DEFAULT_SOURCESET=gemmascope-res-16k
          NEXT_PUBLIC_DEFAULT_SOURCE=20-gemmascope-res-16k
          NEXT_PUBLIC_DEFAULT_RELEASE_NAME=gemma-scope

          # User IDs (will be created at runtime)
          DEFAULT_CREATOR_USER_ID=mistudio-admin
          PUBLIC_ACTIVATIONS_USER_IDS=mistudio-admin
          INFERENCE_ACTIVATION_USER_ID=mistudio-admin

          # Steering defaults
          NEXT_PUBLIC_DEFAULT_STEER_MODEL=gemma-2-2b-it
          NEXT_PUBLIC_STEER_FORCE_ALLOW_INSTRUCT_MODELS=gemma-2-2b-it

          # Local inference (not public demo servers)
          INFERENCE_SERVER_SECRET=local-secret
          AUTOINTERPRET_SERVER_SECRET=local-secret
          EOF

      - name: Copy custom .env to root for monorepo build
        run: |
          cp neuronpedia/apps/webapp/.env neuronpedia/.env

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: neuronpedia/apps/webapp
          file: neuronpedia/apps/webapp/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENV_FILE=.env

      - name: Output image info
        run: |
          echo "Image pushed: ${{ env.IMAGE_NAME }}:latest"
          echo "Image pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "To deploy to K8s, run:"
          echo "  kubectl -n neuronpedia set image deployment/neuronpedia-webapp webapp=${{ env.IMAGE_NAME }}:${{ github.sha }}"
