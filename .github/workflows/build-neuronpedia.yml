name: Build Neuronpedia Webapp

on:
  workflow_dispatch:
    inputs:
      neuronpedia_ref:
        description: 'Neuronpedia repo ref (branch/tag/commit)'
        required: false
        default: 'main'

env:
  REGISTRY: docker.io
  IMAGE_NAME: hitsai/neuronpedia-webapp

jobs:
  build:
    # Only run in hitsainet/miStudio (same as docker-images.yml)
    if: github.repository == 'hitsainet/miStudio'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout miStudio repo
        uses: actions/checkout@v4
        with:
          path: mistudio

      - name: Checkout Neuronpedia repo
        uses: actions/checkout@v4
        with:
          repository: hijohnnylin/neuronpedia
          ref: ${{ github.event.inputs.neuronpedia_ref || 'main' }}
          path: neuronpedia

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Update .env.localhost for K8s deployment
        working-directory: neuronpedia/apps/webapp
        run: |
          # Customize .env.localhost for K8s deployment

          echo "=== Original .env.localhost ==="
          cat .env.localhost

          # CRITICAL: Remove database URLs so they use K8s env vars at runtime
          # The baked-in localhost URLs would override K8s secrets
          sed -i '/^POSTGRES_PRISMA_URL=/d' .env.localhost
          sed -i '/^POSTGRES_URL_NON_POOLING=/d' .env.localhost
          sed -i '/^DATABASE_URL=/d' .env.localhost

          # Append our overrides
          cat >> .env.localhost << 'ENVEOF'

          # === MiStudio K8s Overrides ===
          # Disable demo mode at build time
          NEXT_PUBLIC_DEMO_MODE=false

          # Contact email
          NEXT_PUBLIC_CONTACT_EMAIL_ADDRESS=admin@mcslab.io

          # Local inference secrets (will use K8s secrets at runtime)
          INFERENCE_SERVER_SECRET=local-secret
          AUTOINTERPRET_SERVER_SECRET=local-secret
          ENVEOF

          echo ""
          echo "=== Updated .env.localhost ==="
          cat .env.localhost

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # IMPORTANT: Context must be the repo root because Dockerfile uses:
          # COPY apps/webapp/package*.json ./
          # COPY apps/webapp ./
          context: neuronpedia
          file: neuronpedia/apps/webapp/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ENV_FILE path is relative to context (repo root)
          build-args: |
            ENV_FILE=apps/webapp/.env.localhost

      - name: Output image info
        run: |
          echo "✅ Image pushed: ${{ env.IMAGE_NAME }}:latest"
          echo "✅ Image pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "To deploy to K8s, run:"
          echo "  kubectl -n neuronpedia set image deployment/neuronpedia-webapp webapp=${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "Or with specific SHA:"
          echo "  kubectl -n neuronpedia set image deployment/neuronpedia-webapp webapp=${{ env.IMAGE_NAME }}:${{ github.sha }}"
