#!/bin/bash

# ==============================================================================
# miStudio - Unified Start/Stop Script
# ==============================================================================
# Usage:
#   ./mistudio dev        Start in development mode (native backend/frontend)
#   ./mistudio prod       Start in production mode (fully containerized)
#   ./mistudio stop       Stop all services
#   ./mistudio status     Show service status
# ==============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

show_usage() {
    echo ""
    echo -e "${CYAN}miStudio - MechInterp Studio${NC}"
    echo ""
    echo "Usage: ./mistudio <command>"
    echo ""
    echo "Commands:"
    echo "  dev       Start in development mode"
    echo "            - Containers: PostgreSQL, Redis, Nginx, Ollama"
    echo "            - Native: Backend, Celery, Frontend"
    echo ""
    echo "  prod      Start in production mode (fully containerized)"
    echo "            - All services run in Docker containers"
    echo ""
    echo "  stop      Stop all services (both modes)"
    echo ""
    echo "  status    Show status of all services"
    echo ""
}

start_dev() {
    echo -e "${CYAN}Starting miStudio in DEVELOPMENT mode${NC}"
    echo "  Containers: PostgreSQL, Redis, Nginx, Ollama"
    echo "  Native: Backend, Celery, Frontend"
    echo ""
    ./start-mistudio.sh
}

start_prod() {
    echo -e "${CYAN}Starting miStudio in PRODUCTION mode${NC}"
    echo "  All services containerized"
    echo ""
    ./start-docker.sh prod
}

stop_all() {
    echo -e "${CYAN}Stopping all miStudio services${NC}"
    echo ""

    # Stop native services first (if running)
    echo "Stopping native services..."
    pkill -f "uvicorn src.main:app" 2>/dev/null || true
    pkill -f "celery.*src.core.celery_app" 2>/dev/null || true
    pkill -f "vite" 2>/dev/null || true

    # Stop Docker services
    echo "Stopping Docker services..."
    docker-compose -f docker-compose.yml down 2>/dev/null || true
    docker-compose -f docker-compose.dev.yml down 2>/dev/null || true

    # Stop Ollama if running separately
    docker stop mistudio-ollama 2>/dev/null || true

    echo ""
    echo -e "${GREEN}âœ“${NC} All services stopped"
}

show_status() {
    echo -e "${CYAN}miStudio Service Status${NC}"
    echo ""

    echo "Docker Containers:"
    docker ps --format "  {{.Names}}\t{{.Status}}" --filter "name=mistudio" 2>/dev/null || echo "  No containers running"

    echo ""
    echo "Native Processes:"
    if pgrep -f "uvicorn src.main:app" > /dev/null 2>&1; then
        echo -e "  Backend (uvicorn)     ${GREEN}running${NC}"
    else
        echo -e "  Backend (uvicorn)     ${RED}stopped${NC}"
    fi

    if pgrep -f "celery.*src.core.celery_app" > /dev/null 2>&1; then
        echo -e "  Celery worker         ${GREEN}running${NC}"
    else
        echo -e "  Celery worker         ${RED}stopped${NC}"
    fi

    if pgrep -f "vite" > /dev/null 2>&1; then
        echo -e "  Frontend (vite)       ${GREEN}running${NC}"
    else
        echo -e "  Frontend (vite)       ${RED}stopped${NC}"
    fi
    echo ""
}

# Main
case "${1:-}" in
    dev)
        start_dev
        ;;
    prod)
        start_prod
        ;;
    stop)
        stop_all
        ;;
    status)
        show_status
        ;;
    *)
        show_usage
        exit 1
        ;;
esac
